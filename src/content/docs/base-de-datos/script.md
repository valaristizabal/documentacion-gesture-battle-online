---
title: Script & auditorias
--- 

```sql
CREATE DATABASE GESTURE_BATTLE_ONLINE;

USE GESTURE_BATTLE_ONLINE;

CREATE TABLE USUARIOS (
    ID_USUARIO VARCHAR(50) PRIMARY KEY,
    NOMBRE_USUARIO VARCHAR(100),
    EMAIL VARCHAR(100) UNIQUE,
    AVATAR_URL VARCHAR(255),
    FECHA_CREACION DATETIME DEFAULT CURRENT_TIMESTAMP,
    ES_ADMIN BOOLEAN DEFAULT FALSE
);

CREATE TABLE ESTADOS_JUGADOR (
    ID_ESTADO_JUGADOR INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_ESTADO_JUGADOR VARCHAR(50) UNIQUE
);

CREATE TABLE ESTADOS_SALA (
    ID_ESTADO_SALA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_ESTADO_SALA VARCHAR(50) UNIQUE
);

CREATE TABLE ESTADOS_PARTIDA (
    ID_ESTADO_PARTIDA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_ESTADO_PARTIDA VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE JUGADORES (
    ID_JUGADOR VARCHAR(50) PRIMARY KEY,
    ID_USUARIO VARCHAR(50),
    ID_ESTADO INT,
    CONFIGURACIONJUEGO JSON,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
    FOREIGN KEY (ID_ESTADO) REFERENCES ESTADOS_JUGADOR(ID_ESTADO_JUGADOR)
);

CREATE TABLE ESTADISTICAS_JUGADOR (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    ID_JUGADOR VARCHAR(50),
    PARTIDAS_JUGADAS INT DEFAULT 0,
    VICTORIAS INT DEFAULT 0,
    TIEMPO_TOTAL_JUGADO TIME DEFAULT '00:00:00',
    FOREIGN KEY (ID_JUGADOR) REFERENCES JUGADORES(ID_JUGADOR)
);

CREATE TABLE GESTOS (
    ID_GESTO INT AUTO_INCREMENT PRIMARY KEY,
    TIPO_GESTO VARCHAR(50),
    TIMESTAMP DATETIME,
    DATOS_GESTO JSON
);

CREATE TABLE MINIJUEGOS (
    ID_MINIJUEGO VARCHAR(50) PRIMARY KEY,
    NOMBRE VARCHAR(100) NOT NULL,
    DESCRIPCION TEXT,
    REGLAS TEXT,
    CONFIGURACION_GESTOS JSON
);

CREATE TABLE SALAS (
    ID_SALA VARCHAR(50) PRIMARY KEY,
    CODIGO_INVITACION VARCHAR(50) UNIQUE,
    CONFIGURACION JSON,
    ESTADO_ACTUAL INT,
    CODIGO_UNICO VARCHAR(100) UNIQUE,
    ES_PRIVADA BOOLEAN DEFAULT FALSE,
    ANFITRION VARCHAR(50),
    MAX_JUGADORES INT DEFAULT 4,
    ID_MINIJUEGO VARCHAR(50),
    FOREIGN KEY (ESTADO_ACTUAL) REFERENCES ESTADOS_SALA(ID_ESTADO_SALA),
    FOREIGN KEY (ANFITRION) REFERENCES JUGADORES(ID_JUGADOR),
    FOREIGN KEY (ID_MINIJUEGO) REFERENCES MINIJUEGOS(ID_MINIJUEGO)
);

CREATE TABLE JUGADORES_SALA (
    ID_JUGADOR VARCHAR(50),
    ID_SALA VARCHAR(50),
    PRIMARY KEY (ID_JUGADOR, ID_SALA),
    FOREIGN KEY (ID_JUGADOR) REFERENCES JUGADORES(ID_JUGADOR),
    FOREIGN KEY (ID_SALA) REFERENCES SALAS(ID_SALA)
);

CREATE TABLE PARTIDAS (
    ID_PARTIDA VARCHAR(50) PRIMARY KEY,
    ID_SALA VARCHAR(50),
    ESTADO_PARTIDA INT,
    CONFIGURACION JSON,
    RESULTADO JSON,
    FOREIGN KEY (ID_SALA) REFERENCES SALAS(ID_SALA),
    FOREIGN KEY (ESTADO_PARTIDA) REFERENCES ESTADOS_PARTIDA(ID_ESTADO_PARTIDA)
);

CREATE TABLE JUGADORES_PARTIDA (
    ID_JUGADOR VARCHAR(50),
    ID_PARTIDA VARCHAR(50),
    PUNTOS INT DEFAULT 0,
    PRIMARY KEY (ID_JUGADOR, ID_PARTIDA),
    FOREIGN KEY (ID_JUGADOR) REFERENCES JUGADORES(ID_JUGADOR),
    FOREIGN KEY (ID_PARTIDA) REFERENCES PARTIDAS(ID_PARTIDA)
);

CREATE TABLE GESTOS_PARTIDA (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    ID_PARTIDA VARCHAR(50),
    ID_JUGADOR VARCHAR(50),
    ID_GESTO INT,
    FOREIGN KEY (ID_PARTIDA) REFERENCES PARTIDAS(ID_PARTIDA),
    FOREIGN KEY (ID_JUGADOR) REFERENCES JUGADORES(ID_JUGADOR),
    FOREIGN KEY (ID_GESTO) REFERENCES GESTOS(ID_GESTO)
);

CREATE TABLE AUDITORIAS (
    ID_AUDITORIA INT AUTO_INCREMENT PRIMARY KEY,
    DB_USER VARCHAR(100),
    ACCION VARCHAR(100),
    ENTIDAD_AFECTADA VARCHAR(50),
    ID_ENTIDAD_AFECTADA VARCHAR(50),
    DESCRIPCION TEXT,
    FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- TRIGGERS PARA AUDITORIA DE USUARIOS
DELIMITER $$
CREATE TRIGGER audit_usuarios_insert AFTER INSERT ON USUARIOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'USUARIOS', NEW.ID_USUARIO, CONCAT('Usuario insertado: ', NEW.NOMBRE_USUARIO));
END$$
CREATE TRIGGER audit_usuarios_update AFTER UPDATE ON USUARIOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'USUARIOS', NEW.ID_USUARIO, CONCAT('Usuario actualizado: ', NEW.NOMBRE_USUARIO));
END$$
CREATE TRIGGER audit_usuarios_delete AFTER DELETE ON USUARIOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'USUARIOS', OLD.ID_USUARIO, CONCAT('Usuario eliminado: ', OLD.NOMBRE_USUARIO));
END$$

-- TRIGGERS PARA AUDITORIA DE ESTADOS_JUGADOR
CREATE TRIGGER audit_estados_jugador_insert AFTER INSERT ON ESTADOS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'ESTADOS_JUGADOR', NEW.ID_ESTADO_JUGADOR, CONCAT('Estado insertado: ', NEW.NOMBRE_ESTADO_JUGADOR));
END$$
CREATE TRIGGER audit_estados_jugador_update AFTER UPDATE ON ESTADOS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'ESTADOS_JUGADOR', NEW.ID_ESTADO_JUGADOR, CONCAT('Estado actualizado: ', NEW.NOMBRE_ESTADO_JUGADOR));
END$$
CREATE TRIGGER audit_estados_jugador_delete AFTER DELETE ON ESTADOS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'ESTADOS_JUGADOR', OLD.ID_ESTADO_JUGADOR, CONCAT('Estado eliminado: ', OLD.NOMBRE_ESTADO_JUGADOR));
END$$

-- TRIGGERS PARA AUDITORIA DE ESTADOS_SALA
CREATE TRIGGER audit_estados_sala_insert AFTER INSERT ON ESTADOS_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'ESTADOS_SALA', NEW.ID_ESTADO_SALA, CONCAT('Estado de sala insertado: ', NEW.NOMBRE_ESTADO_SALA));
END$$
CREATE TRIGGER audit_estados_sala_update AFTER UPDATE ON ESTADOS_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'ESTADOS_SALA', NEW.ID_ESTADO_SALA, CONCAT('Estado de sala actualizado: ', NEW.NOMBRE_ESTADO_SALA));
END$$
CREATE TRIGGER audit_estados_sala_delete AFTER DELETE ON ESTADOS_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'ESTADOS_SALA', OLD.ID_ESTADO_SALA, CONCAT('Estado de sala eliminado: ', OLD.NOMBRE_ESTADO_SALA));
END$$

-- TRIGGERS PARA AUDITORIA DE ESTADOS_PARTIDA
CREATE TRIGGER audit_estados_partida_insert AFTER INSERT ON ESTADOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'ESTADOS_PARTIDA', NEW.ID_ESTADO_PARTIDA, CONCAT('Estado de partida insertado: ', NEW.NOMBRE_ESTADO_PARTIDA));
END$$
CREATE TRIGGER audit_estados_partida_update AFTER UPDATE ON ESTADOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'ESTADOS_PARTIDA', NEW.ID_ESTADO_PARTIDA, CONCAT('Estado de partida actualizado: ', NEW.NOMBRE_ESTADO_PARTIDA));
END$$
CREATE TRIGGER audit_estados_partida_delete AFTER DELETE ON ESTADOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'ESTADOS_PARTIDA', OLD.ID_ESTADO_PARTIDA, CONCAT('Estado de partida eliminado: ', OLD.NOMBRE_ESTADO_PARTIDA));
END$$

-- TRIGGERS PARA AUDITORIA DE JUGADORES
CREATE TRIGGER audit_jugadores_insert AFTER INSERT ON JUGADORES
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'JUGADORES', NEW.ID_JUGADOR, CONCAT('Jugador insertado: ', NEW.ID_USUARIO));
END$$
CREATE TRIGGER audit_jugadores_update AFTER UPDATE ON JUGADORES
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'JUGADORES', NEW.ID_JUGADOR, CONCAT('Jugador actualizado: ', NEW.ID_USUARIO));
END$$
CREATE TRIGGER audit_jugadores_delete AFTER DELETE ON JUGADORES
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'JUGADORES', OLD.ID_JUGADOR, CONCAT('Jugador eliminado: ', OLD.ID_USUARIO));
END$$

-- TRIGGERS PARA AUDITORIA DE ESTADISTICAS_JUGADOR
CREATE TRIGGER audit_estadisticas_jugador_insert AFTER INSERT ON ESTADISTICAS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'ESTADISTICAS_JUGADOR', NEW.ID, CONCAT('Estadísticas insertadas para jugador: ', NEW.ID_JUGADOR));
END$$
CREATE TRIGGER audit_estadisticas_jugador_update AFTER UPDATE ON ESTADISTICAS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'ESTADISTICAS_JUGADOR', NEW.ID, CONCAT('Estadísticas actualizadas para jugador: ', NEW.ID_JUGADOR));
END$$
CREATE TRIGGER audit_estadisticas_jugador_delete AFTER DELETE ON ESTADISTICAS_JUGADOR
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'ESTADISTICAS_JUGADOR', OLD.ID, CONCAT('Estadísticas eliminadas para jugador: ', OLD.ID_JUGADOR));
END$$

-- TRIGGERS PARA AUDITORIA DE GESTOS
CREATE TRIGGER audit_gestos_insert AFTER INSERT ON GESTOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'GESTOS', NEW.ID_GESTO, CONCAT('Gesto insertado: ', NEW.TIPO_GESTO));
END$$
CREATE TRIGGER audit_gestos_update AFTER UPDATE ON GESTOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'GESTOS', NEW.ID_GESTO, CONCAT('Gesto actualizado: ', NEW.TIPO_GESTO));
END$$
CREATE TRIGGER audit_gestos_delete AFTER DELETE ON GESTOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'GESTOS', OLD.ID_GESTO, CONCAT('Gesto eliminado: ', OLD.TIPO_GESTO));
END$$

-- TRIGGERS PARA AUDITORIA DE MINIJUEGOS
CREATE TRIGGER audit_minijuegos_insert AFTER INSERT ON MINIJUEGOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'MINIJUEGOS', NEW.ID_MINIJUEGO, CONCAT('Minijuego insertado: ', NEW.NOMBRE));
END$$
CREATE TRIGGER audit_minijuegos_update AFTER UPDATE ON MINIJUEGOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'MINIJUEGOS', NEW.ID_MINIJUEGO, CONCAT('Minijuego actualizado: ', NEW.NOMBRE));
END$$
CREATE TRIGGER audit_minijuegos_delete AFTER DELETE ON MINIJUEGOS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'MINIJUEGOS', OLD.ID_MINIJUEGO, CONCAT('Minijuego eliminado: ', OLD.NOMBRE));
END$$

-- TRIGGERS PARA AUDITORIA DE SALAS
CREATE TRIGGER audit_salas_insert AFTER INSERT ON SALAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'SALAS', NEW.ID_SALA, CONCAT('Sala insertada: ', NEW.CODIGO_INVITACION));
END$$
CREATE TRIGGER audit_salas_update AFTER UPDATE ON SALAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'SALAS', NEW.ID_SALA, CONCAT('Sala actualizada: ', NEW.CODIGO_INVITACION));
END$$
CREATE TRIGGER audit_salas_delete AFTER DELETE ON SALAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'SALAS', OLD.ID_SALA, CONCAT('Sala eliminada: ', OLD.CODIGO_INVITACION));
END$$

-- TRIGGERS PARA AUDITORIA DE JUGADORES_SALA
CREATE TRIGGER audit_jugadores_sala_insert AFTER INSERT ON JUGADORES_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'JUGADORES_SALA', CONCAT(NEW.ID_JUGADOR, '-', NEW.ID_SALA), 'Jugador insertado en sala');
END$$
CREATE TRIGGER audit_jugadores_sala_update AFTER UPDATE ON JUGADORES_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'JUGADORES_SALA', CONCAT(NEW.ID_JUGADOR, '-', NEW.ID_SALA), 'Jugador actualizado en sala');
END$$
CREATE TRIGGER audit_jugadores_sala_delete AFTER DELETE ON JUGADORES_SALA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'JUGADORES_SALA', CONCAT(OLD.ID_JUGADOR, '-', OLD.ID_SALA), 'Jugador eliminado de sala');
END$$

-- TRIGGERS PARA AUDITORIA DE PARTIDAS
CREATE TRIGGER audit_partidas_insert AFTER INSERT ON PARTIDAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'PARTIDAS', NEW.ID_PARTIDA, 'Partida insertada');
END$$
CREATE TRIGGER audit_partidas_update AFTER UPDATE ON PARTIDAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'PARTIDAS', NEW.ID_PARTIDA, 'Partida actualizada');
END$$
CREATE TRIGGER audit_partidas_delete AFTER DELETE ON PARTIDAS
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'PARTIDAS', OLD.ID_PARTIDA, 'Partida eliminada');
END$$

-- TRIGGERS PARA AUDITORIA DE JUGADORES_PARTIDA
CREATE TRIGGER audit_jugadores_partida_insert AFTER INSERT ON JUGADORES_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'JUGADORES_PARTIDA', CONCAT(NEW.ID_JUGADOR, '-', NEW.ID_PARTIDA), 'Jugador insertado en partida');
END$$
CREATE TRIGGER audit_jugadores_partida_update AFTER UPDATE ON JUGADORES_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'JUGADORES_PARTIDA', CONCAT(NEW.ID_JUGADOR, '-', NEW.ID_PARTIDA), 'Jugador actualizado en partida');
END$$
CREATE TRIGGER audit_jugadores_partida_delete AFTER DELETE ON JUGADORES_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'JUGADORES_PARTIDA', CONCAT(OLD.ID_JUGADOR, '-', OLD.ID_PARTIDA), 'Jugador eliminado de partida');
END$$

-- TRIGGERS PARA AUDITORIA DE GESTOS_PARTIDA
CREATE TRIGGER audit_gestos_partida_insert AFTER INSERT ON GESTOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'INSERT', 'GESTOS_PARTIDA', NEW.ID, 'Gesto insertado en partida');
END$$
CREATE TRIGGER audit_gestos_partida_update AFTER UPDATE ON GESTOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'UPDATE', 'GESTOS_PARTIDA', NEW.ID, 'Gesto actualizado en partida');
END$$
CREATE TRIGGER audit_gestos_partida_delete AFTER DELETE ON GESTOS_PARTIDA
FOR EACH ROW BEGIN
    INSERT INTO AUDITORIAS (DB_USER, ACCION, ENTIDAD_AFECTADA, ID_ENTIDAD_AFECTADA, DESCRIPCION)
    VALUES (USER(), 'DELETE', 'GESTOS_PARTIDA', OLD.ID, 'Gesto eliminado de partida');
END$$

DELIMITER ;

